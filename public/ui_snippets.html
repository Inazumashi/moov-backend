<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>UI snippets</title>
  <style>
    .btn-delete { background:#c62828;color:white;padding:8px 12px;border-radius:6px;border:none;cursor:pointer }
    .pw-toggle { margin-left:8px; cursor:pointer }
  </style>
</head>
<body>
  <h3>Password field with visibility toggle</h3>
  <label>
    Mot de passe:
    <input id="pw" type="password" />
    <button id="togglePw" class="pw-toggle">Voir</button>
  </label>

  <h3>Example Delete Ride button (calls API)</h3>
  <p>Replace <code>RIDE_ID</code> and include a valid `Authorization: Bearer &lt;token&gt;` header.</p>
  <div>
    <button id="refreshRides">Charger mes trajets</button>
    <div id="ridesList" style="margin-top:12px"></div>
  </div>

  <h3>Chat & Conversations (exemples)</h3>
  <div>
    <button id="loadConversations">Charger mes conversations</button>
    <button id="checkUnread">Voir nombre de messages non lus</button>
    <div id="conversations" style="margin-top:12px"></div>
  </div>

  <h3>Stats (dashboard)</h3>
  <div>
    <button id="loadStats">Charger stats (dashboard)</button>
    <pre id="statsOut" style="background:#f7f7f7;padding:8px;border-radius:6px;margin-top:8px"></pre>
  </div>

  <script>
    document.getElementById('togglePw').addEventListener('click', (e) => {
      e.preventDefault();
      const pw = document.getElementById('pw');
      if (pw.type === 'password') {
        pw.type = 'text';
        e.target.textContent = 'Cacher';
      } else {
        pw.type = 'password';
        e.target.textContent = 'Voir';
      }
    });

    // Helper to perform delete (permanent) and show result
    async function deleteRide(rideId, token) {
      try {
        // Try the explicit /remove route first
        let url = `/api/rides/${rideId}/remove`;
        let res = await fetch(url, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // If the /remove route returns 404 or 403, try the alternative with query param
        if (res.status === 404 || res.status === 403 || res.status === 405) {
          url = `/api/rides/${rideId}?permanent=1`;
          res = await fetch(url, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        }

        const data = await res.json();
        if (res.ok) {
          alert(data.message || 'Trajet supprimé');
          refreshRidesList(token);
        } else {
          alert('Erreur: ' + (data.message || JSON.stringify(data)));
        }
      } catch (err) {
        alert('Erreur lors de la requête: ' + err.message);
      }
    }

    // Render rides and attach only a delete button (no edit)
    async function refreshRidesList(token) {
      const container = document.getElementById('ridesList');
      container.innerHTML = 'Chargement...';

      try {
        const res = await fetch('/api/rides/my-rides', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (!res.ok) {
          container.innerHTML = 'Erreur: ' + (data.message || JSON.stringify(data));
          return;
        }

        const rides = data.rides || [];
        if (rides.length === 0) {
          container.innerHTML = '<i>Aucun trajet trouvé.</i>';
          return;
        }

        container.innerHTML = '';
        rides.forEach(r => {
          const div = document.createElement('div');
          div.style.border = '1px solid #ddd';
          div.style.padding = '8px';
          div.style.marginBottom = '8px';

          const title = document.createElement('div');
          title.textContent = `${r.id} — ${r.departure_station} → ${r.arrival_station} (${r.departure_date})`;
          div.appendChild(title);

          const btn = document.createElement('button');
          btn.className = 'btn-delete';
          btn.textContent = 'Supprimer';
          btn.disabled = !r.can_delete;
          btn.title = r.can_delete ? 'Supprimer définitivement ce trajet' : 'Impossible: réservations actives';
          btn.addEventListener('click', () => {
            if (!confirm('Confirmer la suppression définitive du trajet #' + r.id + ' ?')) return;
            deleteRide(r.id, token);
          });

          div.appendChild(btn);
          container.appendChild(div);
        });
      } catch (err) {
        container.innerHTML = 'Erreur: ' + err.message;
      }
    }

    // Wire the refresh button to prompt for token then load rides
    document.getElementById('refreshRides').addEventListener('click', async () => {
      const token = prompt('Token (Bearer) pour l\'authentification');
      if (!token) return alert('Token requis');
      refreshRidesList(token);
    });

    // --- Chat helpers ---
    async function apiFetch(path, token, opts = {}) {
      const headers = opts.headers || {};
      headers['Authorization'] = `Bearer ${token}`;
      if (opts.body && !(opts.body instanceof FormData)) headers['Content-Type'] = 'application/json';
      const res = await fetch(path, Object.assign({}, opts, { headers }));
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }

    document.getElementById('loadConversations').addEventListener('click', async () => {
      const token = prompt('Token (Bearer) pour l\'authentification');
      if (!token) return alert('Token requis');
      const out = document.getElementById('conversations');
      out.innerHTML = 'Chargement...';
      const { res, data } = await apiFetch('/api/chat/conversations', token);
      if (!res.ok) return out.innerHTML = 'Erreur: ' + (data.message || JSON.stringify(data));
      out.innerHTML = '';
      data.conversations.forEach(c => {
        const d = document.createElement('div');
        d.style.border = '1px solid #ddd'; d.style.padding = '8px'; d.style.marginBottom = '8px';
        d.innerHTML = `<strong>${c.other_user_name}</strong> — ${c.departure_station} → ${c.arrival_station} <br>Dernier: ${c.last_message || '<aucun>'}`;
        const open = document.createElement('button');
        open.textContent = 'Ouvrir';
        open.style.marginLeft = '8px';
        open.addEventListener('click', () => openConversation(token, c.id));
        d.appendChild(open);
        const del = document.createElement('button');
        del.textContent = 'Supprimer';
        del.style.marginLeft = '6px';
        del.addEventListener('click', async () => {
          if (!confirm('Supprimer conversation ?')) return;
          const { res } = await apiFetch(`/api/chat/conversations/${c.id}`, token, { method: 'DELETE' });
          if (res.ok) { d.remove(); } else alert('Erreur suppression');
        });
        d.appendChild(del);
        out.appendChild(d);
      });
    });

    async function openConversation(token, conversationId) {
      const { res, data } = await apiFetch(`/api/chat/messages/${conversationId}`, token);
      if (!res.ok) return alert('Erreur chargement messages: ' + (data.message || JSON.stringify(data)));
      const msgs = data.messages || [];
      let view = 'Messages:\n\n';
      msgs.forEach(m => view += `${m.sender_first_name} ${m.sender_last_name}: ${m.message}\n`);
      const reply = prompt(view + '\nVotre message (laisser vide pour annuler)');
      if (reply && reply.trim()) {
        const { res: r2, data: d2 } = await apiFetch('/api/chat/messages', token, { method: 'POST', body: JSON.stringify({ conversationId, message: reply }) });
        if (!r2.ok) return alert('Erreur envoi: ' + (d2.message || JSON.stringify(d2)));
        alert('Message envoyé');
      }
    }

    document.getElementById('checkUnread').addEventListener('click', async () => {
      const token = prompt('Token (Bearer) pour l\'authentification');
      if (!token) return alert('Token requis');
      const { res, data } = await apiFetch('/api/chat/unread-count', token);
      if (!res.ok) return alert('Erreur: ' + (data.message || JSON.stringify(data)));
      alert('Messages non lus: ' + (data.unread_count || 0));
    });

    // --- Stats ---
    document.getElementById('loadStats').addEventListener('click', async () => {
      const token = prompt('Token (Bearer) pour l\'authentification');
      if (!token) return alert('Token requis');
      const out = document.getElementById('statsOut');
      out.textContent = 'Chargement...';
      const { res, data } = await apiFetch('/api/stats/dashboard', token);
      if (!res.ok) return out.textContent = 'Erreur: ' + (data.message || JSON.stringify(data));
      out.textContent = JSON.stringify(data.stats, null, 2);
    });
  </script>
</body>
</html>
